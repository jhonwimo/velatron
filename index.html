<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Velatron vs Osos ‚Äî Juego</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    touch-action: none;
  }

  body {
    background: linear-gradient(180deg,#071026,#0b1220);
    font-family: Inter, Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  canvas {
    width: 100vw !important;
    height: 100vh !important;
    display: block;
    background: linear-gradient(180deg,#0b1220,#102033);
  }

  #hud {
    position: fixed;
    top: 10px;
    left: 12px;
    color: white;
    font-size: 18px;
    z-index: 10;
  }
</style>
</head>

<body onload="resizeCanvas()" onresize="resizeCanvas()">

<div id="hud">Puntos: 0 ¬∑ Vidas: 3 ¬∑ üöÄ ESPACIO: L√°ser ¬∑ üó°Ô∏è Z: Sable</div>
<canvas id="game"></canvas>

<script>
/* ---------------- Canvas ---------------- */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();

/* ---------------- Estado ---------------- */
let WIDTH = canvas.width;
let HEIGHT = canvas.height;

let running = true;
let score = 0;
let lives = 3;
let lastTime = 0;

/* ---------------- Jugador ---------------- */
const playerImg = new Image();
playerImg.src = "velatron.png";

const osoImg = new Image();
osoImg.src = "oso.jpg";

/* ---------------- Audio ---------------- */
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
let audioInitialized = false;

// Funci√≥n para crear sonidos sint√©ticos
function createTone(frequency, duration, type = 'sine', volume = 0.3) {
  if (!audioInitialized) return;
  
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
  oscillator.type = type;
  
  gainNode.gain.setValueAtTime(0, audioContext.currentTime);
  gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + duration);
}

// Sonidos del juego
function playLaserSound() {
  createTone(800, 0.15, 'sawtooth', 0.2);
  setTimeout(() => createTone(1200, 0.1, 'sine', 0.15), 50);
}

function playSwordSound() {
  createTone(400, 0.2, 'square', 0.25);
  setTimeout(() => createTone(600, 0.15, 'sawtooth', 0.2), 80);
}

function playExplosionSound() {
  // Explosi√≥n con ruido blanco
  if (!audioInitialized) return;
  
  const bufferSize = audioContext.sampleRate * 0.3;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const output = buffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    output[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 2);
  }
  
  const source = audioContext.createBufferSource();
  const gainNode = audioContext.createGain();
  
  source.buffer = buffer;
  source.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
  
  source.start();
}

function playHitSound() {
  createTone(200, 0.3, 'sawtooth', 0.3);
  setTimeout(() => createTone(150, 0.2, 'triangle', 0.25), 100);
}

// Inicializar audio en la primera interacci√≥n
function initAudio() {
  if (audioInitialized) return;
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
  audioInitialized = true;
}

const player = {
  x: 100,
  y: HEIGHT - 200,
  w: 140,
  h: 140,
  vx: 0,
  speed: 6,
  facing: 1,
  attacking: false,
  attackStart: 0,
  attackDuration: 220,
};

let keys = {};

/* ---------------- Osos ---------------- */
let bears = [];
let heads = [];
let spawnTimer = 0;
let spawnInterval = 1200;

/* ---------------- L√°seres ---------------- */
let lasers = [];
let lastShot = 0;
let shootCooldown = 300; // 300ms entre disparos

function spawnBear(){
  const size = 110;
  bears.push({
    x: Math.random()*(WIDTH - size - 40) + 20,
    y: -size - 40,
    w: size,
    h: size,
    speed: 1 + Math.random()*1.8,
  });
}

/* ---------------- ATAQUE tipo sable l√°ser verde ---------------- */
function getSwordRegion(){
  const width = 150;
  const height = 26;

  if (player.facing === 1){
    return { x: player.x + player.w*0.75, y: player.y + player.h*0.33, w: width, h: height };
  } else {
    return { x: player.x - width*0.78, y: player.y + player.h*0.33, w: width, h: height };
  }
}

function startAttack(){
  if (player.attacking) return;
  player.attacking = true;
  player.attackStart = performance.now();
  playSwordSound(); // Sonido de sable l√°ser
}

/* ---------------- Disparo de L√°ser ---------------- */
function shootLaser(){
  const now = performance.now();
  if (now - lastShot < shootCooldown) return;
  
  lastShot = now;
  playLaserSound(); // Sonido de disparo
  
  // crear l√°ser desde el centro del jugador
  lasers.push({
    x: player.x + player.w/2 - 3,
    y: player.y + 20,
    w: 6,
    h: 20,
    speed: 12,
    glow: 0
  });
}

/* ---------------- Controles t√°ctiles ---------------- */
let touchX = null;
let lastTouchTime = 0;

canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  initAudio(); // Inicializar audio en primera interacci√≥n
  const t = e.touches[0];
  const px = player.x + player.w/2;
  const now = performance.now();

  // doble toque = disparar l√°ser
  if (now - lastTouchTime < 300) {
    shootLaser();
    lastTouchTime = 0;
    return;
  }
  lastTouchTime = now;

  // tocar en el cuerpo del jugador = ataque
  if (t.clientY >= player.y && t.clientY <= player.y + player.h) {
    startAttack();
    return;
  }

  // mover izquierda o derecha
  if (t.clientX < px){
    keys["left"] = true;
    keys["right"] = false;
  } else {
    keys["right"] = true;
    keys["left"] = false;
  }
});

canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  const t = e.touches[0];
  const px = player.x + player.w/2;

  if (t.clientX < px){
    keys["left"] = true;
    keys["right"] = false;
  } else {
    keys["right"] = true;
    keys["left"] = false;
  }
});

canvas.addEventListener("touchend", e => {
  e.preventDefault();
  keys["left"] = false;
  keys["right"] = false;
});

/* ---------------- Controles de teclado ---------------- */
document.addEventListener("keydown", e => {
  initAudio(); // Inicializar audio en primera interacci√≥n
  switch(e.code) {
    case "ArrowLeft":
    case "KeyA":
      keys["left"] = true;
      break;
    case "ArrowRight":
    case "KeyD":
      keys["right"] = true;
      break;
    case "Space":
      e.preventDefault();
      shootLaser();
      break;
    case "KeyZ":
    case "Enter":
      startAttack();
      break;
  }
});

document.addEventListener("keyup", e => {
  switch(e.code) {
    case "ArrowLeft":
    case "KeyA":
      keys["left"] = false;
      break;
    case "ArrowRight":
    case "KeyD":
      keys["right"] = false;
      break;
  }
});

/* ---------------- Colisiones ---------------- */
function rectsCollide(a,b){
  return a.x < b.x + b.w &&
         a.x + a.w > b.x &&
         a.y < b.y + b.h &&
         a.y + a.h > b.y;
}

/* ---------------- Update ---------------- */
function update(dt){
  WIDTH = canvas.width;
  HEIGHT = canvas.height;
  player.y = HEIGHT - 200;

  // movimiento
  player.vx = 0;
  if (keys.left) { player.vx = -player.speed; player.facing = -1; }
  if (keys.right){ player.vx =  player.speed; player.facing =  1; }

  player.x += player.vx;
  player.x = Math.max(10, Math.min(WIDTH - player.w - 10, player.x));

  // ataque
  if (player.attacking){
    if (performance.now() - player.attackStart > player.attackDuration){
      player.attacking = false;
    }
  }

  // osos
  for (let i = bears.length - 1; i >= 0; i--){
    const b = bears[i];
    b.y += b.speed;

    // golpe al jugador
    if (rectsCollide(b, player)){
      lives--;
      bears.splice(i,1);
      playHitSound(); // Sonido de da√±o
      if (lives <= 0){
        alert("GAME OVER - Puntos: " + score);
        document.location.reload();
      }
      continue;
    }

    // golpe con el sable verde
    if (player.attacking){
      const s = getSwordRegion();
      if (rectsCollide(s, b)){
        score += 25;
        bears.splice(i,1);
        playExplosionSound(); // Sonido de explosi√≥n
        continue;
      }
    }

    if (b.y > HEIGHT + 80){
      bears.splice(i,1);
      lives--;
    }
  }

  // l√°seres
  for (let i = lasers.length - 1; i >= 0; i--){
    const l = lasers[i];
    l.y -= l.speed;
    l.glow = (l.glow + 0.1) % (Math.PI * 2);

    // colisi√≥n l√°ser-oso
    for (let j = bears.length - 1; j >= 0; j--){
      const b = bears[j];
      if (rectsCollide(l, b)){
        score += 50; // m√°s puntos por disparar
        bears.splice(j, 1);
        lasers.splice(i, 1);
        playExplosionSound(); // Sonido de explosi√≥n
        break;
      }
    }

    // eliminar l√°seres que salen de pantalla
    if (l.y < -50){
      lasers.splice(i, 1);
    }
  }

  // spawn
  spawnTimer += dt;
  if (spawnTimer >= spawnInterval){
    spawnTimer = 0;
    spawnBear();
    spawnInterval = Math.max(550, spawnInterval - 10);
  }

  hud.textContent = `Puntos: ${score} ¬∑ Vidas: ${lives}`;
}

/* ---------------- Draw ---------------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // suelo
  ctx.fillStyle = "#08131a";
  ctx.fillRect(0, HEIGHT - 40, WIDTH, 40);

  // osos
  bears.forEach(b => {
    ctx.drawImage(osoImg, b.x, b.y, b.w, b.h);
  });

  // l√°seres disparados
  lasers.forEach(l => {
    ctx.save();
    
    // efecto de brillo pulsante
    const intensity = 0.7 + 0.3 * Math.sin(l.glow * 3);
    ctx.shadowColor = "#00ffff";
    ctx.shadowBlur = 15;
    
    // l√°ser principal (cian brillante)
    ctx.fillStyle = `rgba(0, 255, 255, ${intensity})`;
    ctx.fillRect(l.x, l.y, l.w, l.h);
    
    // n√∫cleo del l√°ser (blanco)
    ctx.fillStyle = `rgba(255, 255, 255, ${intensity * 0.8})`;
    ctx.fillRect(l.x + 1, l.y, l.w - 2, l.h);
    
    ctx.restore();
  });

  // sable l√°ser verde
  if (player.attacking){
    const s = getSwordRegion();
    ctx.save();
    ctx.shadowColor = "lime";
    ctx.shadowBlur = 18;
    ctx.fillStyle = "rgba(0,255,0,0.8)";
    ctx.fillRect(s.x, s.y, s.w, s.h);
    ctx.restore();
  }

  // jugador
  ctx.save();
  if (player.facing === -1){
    ctx.translate(player.x + player.w/2, player.y);
    ctx.scale(-1,1);
    ctx.drawImage(playerImg, -player.w/2, 0, player.w, player.h);
  } else {
    ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
  }
  ctx.restore();
}

/* ---------------- Loop ---------------- */
function loop(now){
  const dt = now - (lastTime || now);
  lastTime = now;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>

</body>
</html>
