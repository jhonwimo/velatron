<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Velatron vs Osos ‚Äî Juego</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    touch-action: none;
  }

  body {
    /* Fondo degradado azul oscuro para el body (el fondo principal que quieres ver) */
    background: linear-gradient(180deg,#071026,#0b1220);
    font-family: Inter, Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  canvas {
    width: 100vw !important;
    height: 100vh !important;
    display: block;
    /* ¬°Aqu√≠ el cambio clave! El canvas debe ser transparente para que se vea el fondo del body */
    background: transparent; 
  }

  #hud {
    position: fixed;
    top: 10px;
    left: 12px;
    color: white;
    font-size: 18px;
    z-index: 10;
  }

  /* Personalizaci√≥n de SweetAlert2 tema Velatron */
  .swal2-popup {
    background: linear-gradient(135deg, #0b1220 0%, #071026 50%, #102033 100%) !important;
    border: 2px solid #00ffff !important;
    border-radius: 15px !important;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.5), inset 0 0 20px rgba(0, 100, 150, 0.3) !important;
  }

  .swal2-title {
    color: #00ffff !important;
    font-family: 'Inter', Arial, sans-serif !important;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.8) !important;
    font-weight: bold !important;
  }

  .swal2-html-container {
    color: #ffffff !important;
    font-family: 'Inter', Arial, sans-serif !important;
    text-shadow: 0 0 5px rgba(255, 255, 255, 0.5) !important;
  }

  .swal2-confirm {
    background: linear-gradient(45deg, #00ffff, #0080ff) !important;
    border: none !important;
    border-radius: 12px !important;
    color: #000 !important;
    font-weight: bold !important;
    font-size: 18px !important;
    padding: 15px 30px !important;
    min-width: 200px !important;
    min-height: 50px !important;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.6) !important;
    transition: all 0.3s ease !important;
    margin: 10px !important;
  }

  .swal2-confirm:hover {
    background: linear-gradient(45deg, #0080ff, #00ffff) !important;
    box-shadow: 0 0 25px rgba(0, 255, 255, 0.8) !important;
    transform: scale(1.05) !important;
  }

  .swal2-cancel {
    background: linear-gradient(45deg, #ff4444, #cc0000) !important;
    border: none !important;
    border-radius: 12px !important;
    color: #fff !important;
    font-weight: bold !important;
    font-size: 18px !important;
    padding: 15px 30px !important;
    min-width: 200px !important;
    min-height: 50px !important;
    box-shadow: 0 0 15px rgba(255, 68, 68, 0.6) !important;
    margin: 10px !important;
  }

  .swal2-cancel:hover {
    background: linear-gradient(45deg, #cc0000, #ff4444) !important;
    box-shadow: 0 0 25px rgba(255, 68, 68, 0.8) !important;
    transform: scale(1.05) !important;
  }

  /* Botones m√°s grandes en dispositivos m√≥viles */
  @media (max-width: 768px) {
    .swal2-confirm, .swal2-cancel {
      font-size: 20px !important;
      padding: 18px 35px !important;
      min-width: 250px !important;
      min-height: 60px !important;
      margin: 15px !important;
    }
    
    .swal2-actions {
      flex-direction: column !important;
      gap: 10px !important;
    }
  }

  /* Botones extra grandes para pantallas muy peque√±as */
  @media (max-width: 480px) {
    .swal2-confirm, .swal2-cancel {
      font-size: 24px !important;
      padding: 22px 45px !important;
      min-width: 320px !important;
      min-height: 70px !important;
      margin: 18px 5px !important;
      letter-spacing: 1px !important;
      font-weight: 900 !important;
    }
    
    .swal2-popup {
      padding: 25px !important;
    }
  }

  /* INTRODUCCI√ìN CINEMATOGR√ÅFICA VELATRON */
  #cinematic-intro {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #000000 0%, #0b1220 30%, #071026 70%, #000000 100%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: 'Inter', Arial, sans-serif;
    overflow: hidden;
  }

  .stars {
    position: absolute;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: starTwinkle 2s infinite alternate;
  }

  .star.moving {
    animation: starMove 3s linear infinite;
  }

  @keyframes starTwinkle {
    0% { opacity: 0.3; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1.2); }
  }

  @keyframes starMove {
    0% { transform: translateX(-10px) translateY(-10px); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateX(calc(100vw + 10px)) translateY(calc(100vh + 10px)); opacity: 0; }
  }

  .intro-logo {
    font-size: clamp(3rem, 8vw, 8rem);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    background: linear-gradient(45deg, #00ffff, #0080ff, #00ffff);
    background-size: 300% 300%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: logoGlow 3s ease-in-out infinite, logoSlide 1.5s ease-out;
    text-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
    margin-bottom: 2rem;
    text-align: center;
  }

  @keyframes logoGlow {
    0%, 100% { 
      background-position: 0% 50%;
      filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.8));
    }
    50% { 
      background-position: 100% 50%;
      filter: drop-shadow(0 0 40px rgba(0, 255, 255, 1));
    }
  }

  @keyframes logoSlide {
    0% { 
      transform: translateY(-100px);
      opacity: 0;
    }
    100% { 
      transform: translateY(0);
      opacity: 1;
    }
  }

  .intro-subtitle {
    font-size: clamp(1rem, 3vw, 2rem);
    color: #ffffff;
    text-align: center;
    margin-bottom: 3rem;
    opacity: 0;
    animation: subtitleFade 2s ease-in 1s forwards;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
  }

  @keyframes subtitleFade {
    0% { 
      opacity: 0;
      transform: translateY(30px);
    }
    100% { 
      opacity: 1;
      transform: translateY(0);
    }
  }

  .intro-button {
    background: linear-gradient(45deg, #00ffff, #0080ff);
    border: none;
    border-radius: 15px;
    color: #000;
    font-weight: 900;
    font-size: clamp(1.2rem, 3vw, 2rem);
    padding: clamp(15px, 3vw, 25px) clamp(30px, 6vw, 50px);
    cursor: pointer;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
    transition: all 0.3s ease;
    opacity: 0;
    animation: buttonAppear 2s ease-in 2s forwards, buttonPulse 2s ease-in-out 4s infinite;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    min-width: clamp(200px, 40vw, 300px);
    text-align: center;
  }

  .intro-button:hover {
    background: linear-gradient(45deg, #0080ff, #00ffff);
    box-shadow: 0 0 50px rgba(0, 255, 255, 1);
    transform: scale(1.05);
  }

  @keyframes buttonAppear {
    0% { 
      opacity: 0;
      transform: scale(0.8) translateY(50px);
    }
    100% { 
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  @keyframes buttonPulse {
    0%, 100% { 
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
    }
    50% { 
      box-shadow: 0 0 50px rgba(0, 255, 255, 1);
    }
  }

  .intro-warning {
    position: absolute;
    bottom: clamp(20px, 5vh, 50px);
    left: 50%;
    transform: translateX(-50%);
    font-size: clamp(0.8rem, 2vw, 1rem);
    color: #cccccc;
    text-align: center;
    opacity: 0;
    animation: warningFade 2s ease-in 3s forwards;
    padding: 0 20px;
  }

  @keyframes warningFade {
    0% { opacity: 0; }
    100% { opacity: 0.7; }
  }

  .intro-hidden {
    display: none !important;
  }

  /* Efectos especiales para la introducci√≥n */
  .energy-pulse {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    border: 2px solid rgba(0, 255, 255, 0.3);
    border-radius: 50%;
    animation: energyPulse 4s ease-in-out infinite;
  }

  .energy-pulse:nth-child(2) {
    animation-delay: 1s;
    width: 300px;
    height: 300px;
  }

  .energy-pulse:nth-child(3) {
    animation-delay: 2s;
    width: 400px;
    height: 400px;
  }

  @keyframes energyPulse {
    0%, 100% {
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
    }
    50% {
      transform: translate(-50%, -50%) scale(1.2);
      opacity: 1;
    }
  }

  /* Responsive para m√≥viles */
  @media (max-width: 768px) {
    .intro-logo {
      margin-bottom: 1.5rem;
    }
    
    .intro-subtitle {
      margin-bottom: 2rem;
      padding: 0 20px;
    }
    
    .intro-button {
      margin: 0 20px;
    }
  }

  @media (max-height: 600px) {
    .intro-logo {
      font-size: clamp(2rem, 6vw, 4rem);
      margin-bottom: 1rem;
    }
    
    .intro-subtitle {
      font-size: clamp(0.9rem, 2.5vw, 1.5rem);
      margin-bottom: 1.5rem;
    }
    
    .intro-warning {
      bottom: 10px;
      font-size: clamp(0.7rem, 1.8vw, 0.9rem);
    }
  }
</style>
</head>

<body onload="initGame()" onresize="resizeCanvas()">

<!-- INTRODUCCI√ìN CINEMATOGR√ÅFICA -->
<div id="cinematic-intro">
  <!-- Estrellas animadas -->
  <div class="stars" id="stars-container"></div>
  
  <!-- Efectos de energ√≠a -->
  <div class="energy-pulse"></div>
  <div class="energy-pulse"></div>
  <div class="energy-pulse"></div>
  
  <!-- Contenido principal -->
  <div class="intro-logo" id="intro-logo">VELATRON</div>
  <div class="intro-subtitle" id="intro-subtitle">DEFENSOR DE LA GALAXIA</div>
  <button class="intro-button" id="start-button" onclick="startGame()">
    üöÄ INICIAR MISI√ìN
  </button>
  
  <!-- Advertencia -->
  <div class="intro-warning">
    üéß Usa auriculares para una experiencia completa<br>
    üì± Toca la pantalla para mover ‚Ä¢ Doble toque para disparar ‚Ä¢ Toca a Velatron para el sable l√°ser
  </div>
</div>

<div id="hud">Puntos: 0 ¬∑ Vidas: 3 ¬∑ üöÄ ESPACIO: L√°ser ¬∑ üó°Ô∏è Z: Sable</div>
<canvas id="game"></canvas>

<script>
/* ---------------- Canvas y Sistema de Introducci√≥n ---------------- */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

// Variables para la introducci√≥n
let introActive = true;
let gameStarted = false;

function initGame() {
  resizeCanvas();
  createStars();
  playIntroMusic();
  
  // Ocultar elementos del juego durante la intro
  canvas.style.display = 'none';
  hud.style.display = 'none';
}

function createStars() {
  const starsContainer = document.getElementById('stars-container');
  const numStars = window.innerWidth < 768 ? 50 : 100;
  
  for (let i = 0; i < numStars; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    
    // Posici√≥n aleatoria
    star.style.left = Math.random() * 100 + '%';
    star.style.top = Math.random() * 100 + '%';
    
    // Tama√±o aleatorio
    const size = Math.random() * 3 + 1;
    star.style.width = size + 'px';
    star.style.height = size + 'px';
    
    // Algunas estrellas se mueven
    if (Math.random() < 0.3) {
      star.classList.add('moving');
      star.style.animationDelay = Math.random() * 3 + 's';
    } else {
      star.style.animationDelay = Math.random() * 2 + 's';
    }
    
    starsContainer.appendChild(star);
  }
}

function playIntroMusic() {
  if (!audioInitialized) return;
  
  // Secuencia musical √©pica
  setTimeout(() => {
    createTone(220, 0.5, 'sawtooth', 0.1); // A
  }, 500);
  
  setTimeout(() => {
    createTone(330, 0.5, 'sawtooth', 0.12); // E
  }, 1000);
  
  setTimeout(() => {
    createTone(440, 0.5, 'sawtooth', 0.15); // A
  }, 1500);
  
  setTimeout(() => {
    createTone(550, 1, 'sawtooth', 0.18); // C#
  }, 2000);
  
  // Acordes de fondo
  setTimeout(() => {
    createTone(110, 2, 'sine', 0.08); // A bajo
    createTone(220, 2, 'sine', 0.06); // A
    createTone(330, 2, 'sine', 0.04); // E
  }, 2500);
}

function startGame() {
  initAudio(); // Asegurar que el audio est√© inicializado
  
  // Efecto de sonido de inicio
  createTone(800, 0.3, 'square', 0.2);
  setTimeout(() => createTone(1200, 0.3, 'square', 0.25), 150);
  setTimeout(() => createTone(1600, 0.5, 'square', 0.3), 300);
  
  // Ocultar introducci√≥n con animaci√≥n
  const intro = document.getElementById('cinematic-intro');
  intro.style.transition = 'opacity 1s ease-out, transform 1s ease-out';
  intro.style.opacity = '0';
  intro.style.transform = 'scale(1.1)';
  
  setTimeout(() => {
    intro.classList.add('intro-hidden');
    canvas.style.display = 'block';
    hud.style.display = 'block';
    gameStarted = true;
    introActive = false;
    
    // Iniciar el juego
    resizeCanvas();
    if (!window.gameLoopStarted) {
      requestAnimationFrame(loop);
      window.gameLoopStarted = true;
    }
  }, 1000);
}

/* ---------------- Estado ---------------- */
let WIDTH = canvas.width;
let HEIGHT = canvas.height;

let running = true;
let score = 0;
let lives = 3;
let lastTime = 0;

/* ---------------- Jugador ---------------- */
const playerImg = new Image();
playerImg.src = "velatron.png"; // Aseg√∫rate de tener este archivo tambi√©n

const osoImg = new Image();
osoImg.src = "oso.png"; // ¬°Este es el oso transparente!

/* ---------------- Audio ---------------- */
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
let audioInitialized = false;

// Funci√≥n para crear sonidos sint√©ticos
function createTone(frequency, duration, type = 'sine', volume = 0.3) {
  if (!audioInitialized) return;
  
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
  oscillator.type = type;
  
  gainNode.gain.setValueAtTime(0, audioContext.currentTime);
  gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + duration);
}

// Sonidos del juego
function playLaserSound() {
  createTone(800, 0.15, 'sawtooth', 0.2);
  setTimeout(() => createTone(1200, 0.1, 'sine', 0.15), 50);
}

function playSwordSound() {
  createTone(400, 0.2, 'square', 0.25);
  setTimeout(() => createTone(600, 0.15, 'sawtooth', 0.2), 80);
}

function playExplosionSound() {
  // Explosi√≥n con ruido blanco
  if (!audioInitialized) return;
  
  const bufferSize = audioContext.sampleRate * 0.3;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const output = buffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    output[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 2);
  }
  
  const source = audioContext.createBufferSource();
  const gainNode = audioContext.createGain();
  
  source.buffer = buffer;
  source.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
  
  source.start();
}

function playHitSound() {
  createTone(200, 0.3, 'sawtooth', 0.3);
  setTimeout(() => createTone(150, 0.2, 'triangle', 0.25), 100);
}

// Inicializar audio en la primera interacci√≥n
function initAudio() {
  if (audioInitialized) return;
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
  audioInitialized = true;
  
  // Reproducir m√∫sica de introducci√≥n si estamos en la intro
  if (introActive) {
    setTimeout(() => playIntroMusic(), 100);
  }
}

/* ---------------- Alertas Velatron ---------------- */
function showGameOver(finalScore) {
  Swal.fire({
    title: '‚ö° GAME OVER ‚ö°',
    html: `
      <div style="text-align: center;">
        <div style="font-size: 1.2em; margin: 10px 0;">üöÄ <strong>VELATRON DESTRUIDO</strong> üöÄ</div>
        <div style="font-size: 1.5em; color: #00ffff; margin: 15px 0;">
          üèÜ Puntuaci√≥n Final: <strong>${finalScore}</strong>
        </div>
        <div style="font-size: 0.9em; opacity: 0.8; margin: 10px 0;">
          Los osos han conquistado la galaxia...<br>
          ¬øIntentar√°s salvar el universo de nuevo?
        </div>
      </div>
    `,
    icon: 'error',
    iconColor: '#ff4444',
    showCancelButton: true,
    confirmButtonText: 'üîÑ REINICIAR MISI√ìN',
    cancelButtonText: '‚ùå ABANDONAR',
    allowOutsideClick: false,
    allowEscapeKey: false,
    backdrop: 'rgba(0, 0, 0, 0.8)'
  }).then((result) => {
    if (result.isConfirmed) {
      document.location.reload();
    } else {
      // Opcional: cerrar pesta√±a o ir a otra p√°gina
      window.close();
    }
    timer: 40000000
  });
}

function showVictory(finalScore) {
  Swal.fire({
    title: 'üåü ¬°VICTORIA √âPICA! üåü',
    html: `
      <div style="text-align: center;">
        <div style="font-size: 1.2em; margin: 10px 0;">‚ö° <strong>VELATRON TRIUNFANTE</strong> ‚ö°</div>
        <div style="font-size: 1.5em; color: #00ffff; margin: 15px 0;">
          üèÜ Puntuaci√≥n: <strong>${finalScore}</strong>
        </div>
        <div style="font-size: 0.9em; opacity: 0.8; margin: 10px 0;">
          ¬°Has salvado la galaxia!<br>
          Los osos han sido derrotados.
        </div>
      </div>
    `,
    icon: 'success',
    iconColor: '#00ffff',
    confirmButtonText: 'üéÆ JUGAR DE NUEVO',
    backdrop: 'rgba(0, 50, 100, 0.8)'
  }).then(() => {
    document.location.reload();
  });
}

const player = {
  x: 100,
  y: HEIGHT - 200,
  w: 288,
  h: 288,
  vx: 0,
  speed: 10,
  facing: 1,
  attacking: false,
  attackStart: 0,
  attackDuration: 220,
};

let keys = {};

/* ---------------- Osos ---------------- */
let bears = [];
let heads = [];
let spawnTimer = 0;
let spawnInterval = 1200;

/* ---------------- L√°seres ---------------- */
let lasers = [];
let lastShot = 0;
let shootCooldown = 300; // 300ms entre disparos

/* ---------------- Explosiones ---------------- */
let explosions = [];

function spawnBear(){
  const size = 110;
  bears.push({
    x: Math.random()*(WIDTH - size - 40) + 20,
    y: -size - 40,
    w: size,
    h: size,
    speed: 1 + Math.random()*1.8,
  });
}

/* ---------------- Explosiones ---------------- */
function createExplosion(x, y) {
  const particles = [];
  const numParticles = 15 + Math.random() * 10;
  
  for (let i = 0; i < numParticles; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 8,
      vy: (Math.random() - 0.5) * 8,
      life: 1.0,
      decay: 0.02 + Math.random() * 0.02,
      size: 3 + Math.random() * 4,
      color: Math.random() < 0.5 ? 'orange' : 'red'
    });
  }
  
  explosions.push({
    particles: particles,
    time: 0,
    duration: 1000
  });
}

/* ---------------- ATAQUE tipo sable l√°ser verde ---------------- */
function getSwordRegion(){
  const width = 150;
  const height = 26;

  if (player.facing === 1){
    return { x: player.x + player.w*0.75, y: player.y + player.h*0.33, w: width, h: height };
  } else {
    return { x: player.x - width*0.78, y: player.y + player.h*0.33, w: width, h: height };
  }
}

function startAttack(){
  if (player.attacking) return;
  player.attacking = true;
  player.attackStart = performance.now();
  playSwordSound(); // Sonido de sable l√°ser
}

/* ---------------- Disparo de L√°ser ---------------- */
function shootLaser(){
  const now = performance.now();
  if (now - lastShot < shootCooldown) return;
  
  lastShot = now;
  playLaserSound(); // Sonido de disparo
  
  // crear l√°ser desde el centro del jugador
  lasers.push({
    x: player.x + player.w/2 - 8,
    y: player.y + 20,
    w: 16,
    h: 35,
    speed: 12,
    glow: 0
  });
}

/* ---------------- Controles t√°ctiles ---------------- */
let touchX = null;
let lastTouchTime = 0;

canvas.addEventListener("touchstart", e => {
  // Solo procesar toques si el juego ha comenzado
  if (!gameStarted || introActive) return;
  
  e.preventDefault();
  initAudio(); // Inicializar audio en primera interacci√≥n
  const t = e.touches[0];
  const px = player.x + player.w/2;
  const now = performance.now();

  // doble toque = disparar l√°ser
  if (now - lastTouchTime < 300) {
    shootLaser();
    lastTouchTime = 0;
    return;
  }
  lastTouchTime = now;

  // tocar en el cuerpo del jugador = ataque
  if (t.clientY >= player.y && t.clientY <= player.y + player.h) {
    startAttack();
    return;
  }

  // mover izquierda o derecha
  if (t.clientX < px){
    keys["left"] = true;
    keys["right"] = false;
  } else {
    keys["right"] = true;
    keys["left"] = false;
  }
});

canvas.addEventListener("touchmove", e => {
  // Solo procesar toques si el juego ha comenzado
  if (!gameStarted || introActive) return;
  
  e.preventDefault();
  const t = e.touches[0];
  const px = player.x + player.w/2;

  if (t.clientX < px){
    keys["left"] = true;
    keys["right"] = false;
  } else {
    keys["right"] = true;
    keys["left"] = false;
  }
});

canvas.addEventListener("touchend", e => {
  // Solo procesar toques si el juego ha comenzado
  if (!gameStarted || introActive) return;
  
  e.preventDefault();
  keys["left"] = false;
  keys["right"] = false;
});

/* ---------------- Controles de teclado ---------------- */
document.addEventListener("keydown", e => {
  initAudio(); // Inicializar audio en primera interacci√≥n
  
  // Si estamos en la introducci√≥n, Enter o Espacio inicia el juego
  if (introActive) {
    if (e.code === "Enter" || e.code === "Space") {
      e.preventDefault();
      startGame();
    }
    return;
  }
  
  // Solo procesar controles si el juego ha comenzado
  if (!gameStarted) return;
  
  switch(e.code) {
    case "ArrowLeft":
    case "KeyA":
      keys["left"] = true;
      break;
    case "ArrowRight":
    case "KeyD":
      keys["right"] = true;
      break;
    case "Space":
      e.preventDefault();
      shootLaser();
      break;
    case "KeyZ":
    case "Enter":
      startAttack();
      break;
  }
});

document.addEventListener("keyup", e => {
  // Solo procesar controles si el juego ha comenzado
  if (!gameStarted || introActive) return;
  
  switch(e.code) {
    case "ArrowLeft":
    case "KeyA":
      keys["left"] = false;
      break;
    case "ArrowRight":
    case "KeyD":
      keys["right"] = false;
      break;
  }
});

/* ---------------- Colisiones ---------------- */
function rectsCollide(a,b){
  return a.x < b.x + b.w &&
          a.x + a.w > b.x &&
          a.y < b.y + b.h &&
          a.y + a.h > b.y;
}

/* ---------------- Update ---------------- */
function update(dt){
  WIDTH = canvas.width;
  HEIGHT = canvas.height;
  player.y = HEIGHT - 450;

  // movimiento
  player.vx = 0;
  if (keys.left) { player.vx = -player.speed; player.facing = -1; }
  if (keys.right){ player.vx =  player.speed; player.facing =  1; }

  player.x += player.vx;
  player.x = Math.max(10, Math.min(WIDTH - player.w - 10, player.x));

  // ataque
  if (player.attacking){
    if (performance.now() - player.attackStart > player.attackDuration){
      player.attacking = false;
    }
  }

  // osos
  for (let i = bears.length - 1; i >= 0; i--){
    const b = bears[i];
    b.y += b.speed;

    // golpe al jugador
    if (rectsCollide(b, player)){
      lives--;
      bears.splice(i,1);
      playHitSound(); // Sonido de da√±o
      if (lives <= 0){
        showGameOver(score);
      }
      continue;
    }

    // golpe con el sable verde
    if (player.attacking){
      const s = getSwordRegion();
      if (rectsCollide(s, b)){
        score += 25;
        bears.splice(i,1);
        playExplosionSound(); // Sonido de explosi√≥n
        continue;
      }
    }

    if (b.y > HEIGHT + 80){
      bears.splice(i,1);
      lives--;
    }
  }

  // explosiones
  for (let i = explosions.length - 1; i >= 0; i--){
    const explosion = explosions[i];
    explosion.time += dt;
    
    // actualizar part√≠culas
    for (let j = explosion.particles.length - 1; j >= 0; j--){
      const p = explosion.particles[j];
      p.x += p.vx;
      p.y += p.vy;
      p.life -= p.decay;
      p.vy += 0.1; // gravedad ligera
      
      if (p.life <= 0){
        explosion.particles.splice(j, 1);
      }
    }
    
    // eliminar explosi√≥n cuando no quedan part√≠culas
    if (explosion.particles.length === 0 || explosion.time > explosion.duration){
      explosions.splice(i, 1);
    }
  }

  // l√°seres
  for (let i = lasers.length - 1; i >= 0; i--){
    const l = lasers[i];
    l.y -= l.speed;
    l.glow = (l.glow + 0.1) % (Math.PI * 2);

    // colisi√≥n l√°ser-oso
    for (let j = bears.length - 1; j >= 0; j--){
      const b = bears[j];
      if (rectsCollide(l, b)){
        score += 50; // m√°s puntos por disparar
        
        // Crear explosi√≥n en el centro del oso
        createExplosion(b.x + b.w/2, b.y + b.h/2);
        
        bears.splice(j, 1);
        lasers.splice(i, 1);
        playExplosionSound(); // Sonido de explosi√≥n
        break;
      }
    }

    // eliminar l√°seres que salen de pantalla
    if (l.y < -50){
      lasers.splice(i, 1);
    }
  }

  // spawn
  spawnTimer += dt;
  if (spawnTimer >= spawnInterval){
    spawnTimer = 0;
    spawnBear();
    spawnInterval = Math.max(550, spawnInterval - 10);
  }

  hud.textContent = `Puntos: ${score} ¬∑ Vidas: ${lives}`;
}

/* ---------------- Draw ---------------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // suelo
  ctx.fillStyle = "#08131a";
  ctx.fillRect(0, HEIGHT - 40, WIDTH, 40);

  // osos (sin fondo - solo la figura del oso)
  bears.forEach(b => {
    ctx.save();
    
    // Crear un canvas temporal para procesar la imagen del oso
    if (!window.processedBearImg) {
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = 200;
      tempCanvas.height = 200;
      
      // Dibujar la imagen original
      tempCtx.drawImage(osoImg, 0, 0, 200, 200);
      
      // Obtener y procesar los p√≠xeles
      const imageData = tempCtx.getImageData(0, 0, 200, 200);
      const data = imageData.data;
      
      // Eliminar fondo blanco/claro
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b_val = data[i + 2];
        const brightness = (r + g + b_val) / 3;
        
        // Si es muy claro (probable fondo), hacerlo transparente
        if (brightness > 200) {
          data[i + 3] = 0; // Completamente transparente
        }
        // Si es gris claro, reducir mucho la opacidad
        else if (brightness > 160) {
          data[i + 3] = Math.max(0, data[i + 3] * 0.2);
        }
        // Si es gris medio, reducir un poco la opacidad
        else if (brightness > 120) {
          data[i + 3] = Math.max(0, data[i + 3] * 0.7);
        }
      }
      
      // Guardar la imagen procesada
      tempCtx.putImageData(imageData, 0, 0);
      window.processedBearImg = tempCanvas;
    }
    
    // Dibujar el oso procesado (solo la figura, sin fondo)
    ctx.drawImage(window.processedBearImg, 0, 0, 200, 200, b.x, b.y, b.w, b.h);
    
    ctx.restore();
  });

  // explosiones
  explosions.forEach(explosion => {
    explosion.particles.forEach(p => {
      ctx.save();
      
      const alpha = p.life;
      ctx.globalAlpha = alpha;
      
      // glow effect
      ctx.shadowColor = p.color;
      ctx.shadowBlur = 8 * alpha;
      
      // part√≠cula principal
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size * alpha, 0, Math.PI * 2);
      ctx.fill();
      
      // n√∫cleo brillante
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size * alpha * 0.5, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.restore();
    });
  });

  // l√°seres disparados
  lasers.forEach(l => {
    ctx.save();
    
    // efecto de brillo pulsante m√°s intenso
    const intensity = 0.8 + 0.2 * Math.sin(l.glow * 4);
    const glowSize = 25 + 10 * Math.sin(l.glow * 2);
    
    // Halo exterior (m√°s grande y brillante)
    ctx.shadowColor = "#00ffff";
    ctx.shadowBlur = glowSize;
    ctx.fillStyle = `rgba(0, 255, 255, ${intensity * 0.3})`;
    ctx.fillRect(l.x - 4, l.y, l.w + 8, l.h);
    
    // L√°ser principal (cian brillante m√°s grande)
    ctx.shadowBlur = 20;
    ctx.fillStyle = `rgba(0, 255, 255, ${intensity})`;
    ctx.fillRect(l.x, l.y, l.w, l.h);
    
    // N√∫cleo del l√°ser (blanco brillante)
    ctx.shadowBlur = 10;
    ctx.fillStyle = `rgba(255, 255, 255, ${intensity * 0.9})`;
    ctx.fillRect(l.x + 3, l.y, l.w - 6, l.h);
    
    // L√≠nea central ultra brillante
    ctx.shadowBlur = 5;
    ctx.fillStyle = `rgba(255, 255, 255, ${intensity})`;
    ctx.fillRect(l.x + 6, l.y, l.w - 12, l.h);
    
    ctx.restore();
  });

  // sable l√°ser verde
  if (player.attacking){
    const s = getSwordRegion();
    ctx.save();
    ctx.shadowColor = "lime";
    ctx.shadowBlur = 18;
    ctx.fillStyle = "rgba(0,255,0,0.8)";
    ctx.fillRect(s.x, s.y, s.w, s.h);
    ctx.restore();
  }

  // jugador
  ctx.save();
  if (player.facing === -1){
    ctx.translate(player.x + player.w/2, player.y);
    ctx.scale(-1,1);
    ctx.drawImage(playerImg, -player.w/2, 0, player.w, player.h);
  } else {
    ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
  }
  ctx.restore();
}

/* ---------------- Loop ---------------- */
function loop(now){
  // Solo ejecutar el juego si ha comenzado
  if (!gameStarted || introActive) {
    requestAnimationFrame(loop);
    return;
  }
  
  const dt = now - (lastTime || now);
  lastTime = now;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}
</script>

</body>
</html>